---
title: "Advanced Modelling - Final Project"
author: "Phong"
date: "2025-03-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(GGally)
library(forcats)
library(mice)
```

# Data

```{r}
booking_data <- read.csv("data/NDAQ-CHB.csv")
```

Link to dataset: <https://data.nasdaq.com/databases/CHB>

## EDA

```{r}
# Check for missing values
sum(is.na(booking_data))

colSums(is.na(booking_data)) %>% 
  as.data.frame() %>% 
  filter(. > 0) %>% 
  rownames_to_column() %>% 
  rename("Column with NA" = 1,
         "Count of NA" = 2)
```

In the dataset, there is only 1 missing value on hotel_state column. However, this column is not relevant for our data modelling.

```{r}
# Check for empty values
colSums(booking_data == "") %>% 
  as.data.frame() %>% 
  filter(. > 0) %>% 
  rownames_to_column() %>% 
  rename("Column with EMPTY" = 1,
         "Count of EMPTY" = 2)
```

There are a lot of empty cells in the dataset. Some of these are valid value as they indicate a 0 value. For example, the empty rows in *cancel_date* indicate that there was not any cancellation made. Another columns of this type are *start_amenities*. For these columns, we will simply transform into dummy columns and replace with 0 for empty cells.

Some of the columns have empty values because simply there is no value (e.g., *hotel_chain_name*, *hotel_chain_ticker_symbol*). For these columns, we will impute using the *hotel_brand_name* column.

For column *hotel_postal_code*, we can impute based on location (*longitude* and *latitude*). However, for the purpose of model building, we will not use this column and we will simply remove this column.

The other columns (*start_commision_info*, *start_cancel_policy*, *start_room_type*, and *start_bed_type*) are actually missing values that can be derived from the other data points and contain relevant information for our models. We, therefore, will later impute them.

```{r}
# Check for duplicate
booking_data %>% 
  filter(duplicated(reservation_id))
```

There is no duplicated reservation in our dataset.

```{r}
# Outlier detection
booking_data %>% 
  ggplot(aes(x = nightly_rate_usd)) +
  geom_boxplot()

# Using z-score
booking_data %>% 
  mutate(z_score = (nightly_rate_usd - mean(nightly_rate_usd)) / sd(nightly_rate_usd)) %>% 
  filter(abs(z_score) > 3)
```

There are certainly outliers in our target varaible nightly_rate_usd. We will need to acknowledge this during the modelling phase as some of the methods are sensitive to outliers (e.g., Linear Regression) while others are more robust and less affected (e.g., Random Forest). As such, we will not remove them from the dataset.

```{r}
# Univariate analysis - Nightly rate (USD)
booking_data %>% 
  mutate(z_score = (nightly_rate_usd - mean(nightly_rate_usd)) / sd(nightly_rate_usd)) %>% 
  # Removing outliers
  filter(abs(z_score) < 3) %>%
  # Visualization of target variable
  ggplot(aes(x = nightly_rate_usd)) +
  geom_histogram(binwidth = 20) +
  geom_vline(aes(xintercept = median(nightly_rate_usd)), color="indianred", linetype="dashed")+
  geom_text(aes(x = median(nightly_rate_usd), label = paste("Median nightly rate:", median(nightly_rate_usd), "(usd)"), y = 1050), color = "indianred", hjust= -0.1) +
  labs(x = "Nightly Rate (USD)", y = "Frequency",
       title = "Distribution of Nightly Rate on Bookings from Businesses") +
  theme_classic() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5))
```

```{r}
# Univariate analysis - Cancellation
booking_data %>% 
  mutate(cancelled = ifelse(cancel_date == "",0,1) %>% as.factor()) %>% 
  ggplot(aes(x = cancelled, fill = cancelled)) +
  geom_bar() + 
  stat_count(geom = "text", colour = "white", aes(label = paste0(..count..," (",round(..count../nrow(booking_data)*100,0), "%)")),position=position_stack(vjust=0.5))+
  scale_fill_discrete(name = "Status", labels = c("Not Cancelled", "Cancelled")) +
  labs(x = "Cancelled Status", y = "Frequency",
       title = "Frequency of Cancellation of Business Hotel Bookings",
       subtitle = "Moderate Degree of Imbalance in Target Variable") +
  theme_classic() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5))
```

In our dataset, there is a moderate degree of imbalance in our dataset for the targeted variable cancellation. This might create some bias when training the models as many of them are created for balanced data. Therefore, we will consider balancing data in the sampling process to mitigate the imbalance.

```{r}
# Multivariate analysis - Nightly rate (USD)
booking_data %>% 
  select_if(is.numeric) %>% 
  select(-c(hotel_latitude, hotel_longitude, nightly_rate_native,total_cost_native)) %>% 
  ggpairs()
```

Using only numeric variables offers little insights to the nightly_rate_usd variable as these features are highly dependent to the nightly rate of the booking (e.g., total cost). We will later create more variables and factorize categorical variables in order to see more variables that influence nightly rate. We expect to see positive correlation between nightly rate and variables such as room type (i.e., deluxe rooms should cost more than standard rooms) or amenities (i.e., more amenities imply more cost).

```{r}
# Multivariate analysis - Cancellation
booking_data %>% 
  mutate(cancelled = ifelse(cancel_date == "",0,1)) %>% 
  group_by(gic_sector) %>% 
  mutate(cancel_percentage = sum(cancelled)/n()) %>% 
  ungroup() %>% 
  filter(cancelled == 1 & gic_sector != "" & start_cancel_policy != "") %>% 
  ggplot(aes(x = fct_infreq(gic_sector), y = cancel_percentage, fill = start_cancel_policy)) +
  geom_col() +
  labs(x = "Client Sector", y = "Cancel Percentage",
       title = "Cancellation Frequency by Sector and Cancellation Policy",
       fill = "Cancellation Policy") +
  theme_classic() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust= 1))
```

Certain sectors seem to have a higher rate of booking cancellation than others (e.g., IT with 20% cancellation rate and Industrial with about 15% cancellation rate). We also observe that more flexible cancellation policies result in higher cancellation where as the less days are given to cancel the booking the less likely the client would cancel.

## Data Cleaning & Pre-processing

```{r}
clean_data <- booking_data %>% 
  # Clean formatting
  mutate(start_bed_type = gsub(",", "", start_bed_type),
         start_cancel_policy = ifelse(start_cancel_policy == "6 Or More Days Before Checkin", "6 or More Days Before Checkin", start_cancel_policy),
         hotel_chain_name = ifelse(hotel_chain_name == "", hotel_brand_name, hotel_chain_name),
         start_commission_info = ifelse(start_commission_info == "", NA, start_commission_info),
         start_cancel_policy = ifelse(start_cancel_policy == "", NA, start_cancel_policy),
         start_room_type = ifelse(start_room_type == "", NA, start_room_type),
         start_bed_type = ifelse(start_bed_type == "", NA, start_bed_type),
         hotel_chain_name = case_when(
           hotel_chain_name == "Ihg" ~ "IHG",
           hotel_chain_name == "Nh Hotels" ~ "NH Hotels",
           hotel_chain_name == "Preferred Hotel & Resorts" ~ "Preferred Hotel Group",
           hotel_chain_name == "Nh Hoteles" ~ "NH Hotels",
           hotel_chain_name == "Shangri-la Hotels And Resorts" ~ "Shangri-La Hotels and Resorts",
           hotel_chain_name == "Supranational Hotels" ~ "Supranational",
           TRUE ~ hotel_chain_name),
         booking_source = toupper(booking_source)) %>% 
  # Data type conversion
  mutate(across(c(added_date, modified_date, created_date, check_in, check_out, cancel_date), as.Date),
         across(c(booking_source, hotel_chain_name, start_commission_info, start_cancel_policy, start_rate_type, start_room_type, start_bed_type, start_amenities, gic_sector),as.factor)) %>% 
  # Remove irrelevant features
  select(-c(hotel_name, hotel_brand_code, hotel_chain_ticker_symbol, hotel_address, hotel_state, hotel_postal_code, nightly_rate_native, total_cost_native,currency_code))
```

```{r}
# Imputation
data_for_imp <- clean_data %>% 
  select(c(created_date, rate_offers, lqr, booking_source, check_in, check_out, nights, hotel_latitude, hotel_longitude, hotel_chain_name, hotel_stars, nightly_rate_usd, total_cost_usd, start_commission_info, start_cancel_policy, start_rate_type, start_room_type, start_bed_type, start_amenities))

imp <- mice(data_for_imp, method = "rf", m = 5, maxit =5, seed=3467)

complete_data <- complete(imp)

clean_data$start_commission_info <- complete_data$start_commission_info
clean_data$start_cancel_policy <- complete_data$start_cancel_policy
clean_data$start_room_type <- complete_data$start_room_type
clean_data$start_bed_type <- complete_data$start_bed_type

# Double check for missing data
colSums(is.na(clean_data))
```

As we explored previously, *start_commision_info*, *start_cancel_policy*, *start_room_type*, and *start_bed_type* had empty values that needed to be imputed. After the imputation, the only column with missing value is *cancel_date*. As stated before, in this column, missing or empty represents no cancellation. We will create a dummy column to represent this in the next section.

## Feature Engineering

### Feature Creation

```{r}
df <- clean_data %>% 
  mutate(free_wifi = ifelse(grepl("Free Wifi", start_amenities), 1,0),
         free_breakfast = ifelse(grepl("Free Breakfast", start_amenities), 1,0),
         free_parking = ifelse(grepl("Free Breakfast", start_amenities), 1,0),
         concierge = ifelse(grepl("Concierge", start_amenities), 1,0),
         amenities = free_wifi+free_breakfast+free_parking+concierge,
         cancelled = ifelse(!is.na(cancel_date),1,0),
         leadtime = as.numeric(check_in - created_date),
         checkin_month = month(check_in),
         weekday_booking = mapply(function(x,y) sum(!weekdays(seq(x, y,"days")) %in% c("Saturday", "Sunday")), check_in,check_out),
         weekend_booking = mapply(function(x,y) sum(weekdays(seq(x, y,"days")) %in% c("Saturday", "Sunday")), check_in,check_out),
         booking_change = ifelse(added_date == modified_date, 0,1),
         bed_type = case_when(grepl("Twin",start_bed_type) ~ "Twin",
                              grepl("Queen",start_bed_type) ~ "Queen",
                              grepl("King",start_bed_type) ~"King"),
         bed_number = ifelse(grepl("Two",start_bed_type), 2,1)
         ) %>% 
  # Previous cancellation per company (client)
  group_by(company_id) %>% 
  mutate(client_cancellation = sum(cancelled)) %>% 
  ungroup() %>% 
  # Previous cancellation per agency
  group_by(agency_id) %>% 
  mutate(agency_cancellation = sum(cancelled)) %>% 
  ungroup() %>% 
  # Previous cancellation per hotel
  group_by(hotel_brand_name) %>% 
  mutate(hotel_cancellation = sum(cancelled)) %>% 
  ungroup() %>% 
  # Correct data type of new features
  mutate(across(c(free_wifi, free_breakfast, free_parking, concierge, cancelled, checkin_month, booking_change, hotel_country, bed_type, bed_number), as.factor)) %>% 
  # Removing booking made after checkin
  filter(leadtime > 0)
```

### Feature Transformation

```{r}
transformation <- df %>% 
  select_if(is.numeric) %>% 
  select(-c(hotel_latitude, hotel_longitude)) 

transformation %>% 
  pivot_longer(cols = everything(), names_to = "var", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ var, scales = "free") +
  theme_classic()

transformation <- transformation %>%
  # Normalise with log and feature squaring transform
  mutate(across(c(amenities, client_cancellation, hotel_cancellation, leadtime, lqr, nightly_rate_usd, nights, rate_offers, total_cost_usd, weekday_booking, weekend_booking), function(x) log(x+1))) %>% 
  mutate(across(c(hotel_stars), function(x) x^2)) %>%
  # Min max normalisation
  mutate(across(everything(), function(x) ((x-min(x))/(max(x)-min(x))))) %>% 
  # Standardize
  mutate(across(everything(), scale))

transformation %>% 
  pivot_longer(cols = everything(), names_to = "var", values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~ var, scales = "free") +
  theme_classic()
```

### Final Dataframe

```{r}
df_final <- cbind(
  df %>% select_if(is.factor),
  df$hotel_latitude,
  df$hotel_longitude,
  transformation
)
```

# Classification

## Interpretation

## Prediction

# Regression

## Interpretation

## Prediction
