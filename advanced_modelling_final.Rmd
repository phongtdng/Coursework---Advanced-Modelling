---
title: "Advanced Modelling - Final Project"
author: "Phong"
date: "2025-03-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
```

# Data

```{r}
booking_data <- read.csv("data/NDAQ-CHB.csv")
```

Link to dataset: <https://data.nasdaq.com/databases/CHB>

## EDA

```{r}
# Check for missing values
sum(is.na(booking_data))

colSums(is.na(booking_data)) %>% 
  as.data.frame() %>% 
  filter(. > 0) %>% 
  rownames_to_column() %>% 
  rename("Column with NA" = 1,
         "Count of NA" = 2)
```

In the dataset, there is only 1 missing value on hotel_state column. However, this column is not relevant for our data modelling.

```{r}
# Check for empty values
colSums(booking_data == "") %>% 
  as.data.frame() %>% 
  filter(. > 0) %>% 
  rownames_to_column() %>% 
  rename("Column with EMPTY" = 1,
         "Count of EMPTY" = 2)
```

There are a lot of empty cells in the dataset. Some of these are valid value as they indicate a 0 value. For example, the empty rows in *cancel_date* indicate that there was not any cancellation made. Another columns of this type are *start_amenities*. For these columns, we will simply transform into dummy columns and replace with 0 for empty cells.

Some of the columns have empty values because simply there is no value (e.g., *hotel_chain_name*, *hotel_chain_ticker_symbol*). For these columns, we will impute using the *hotel_brand_name* column.

For column *hotel_postal_code*, we can impute based on location (*longitude* and *latitude*). However, for the purpose of model building, we will not use this column and we will simply remove this column.

The other columns (*start_commision_info*, *start_cancel_policy*, *start_room_type*, and *start_bed_type*) are actually missing values that can be derived from the other data points and contain relevant information for our models. We, therefore, will later impute them.

```{r}
# Check for duplicate
booking_data %>% 
  filter(duplicated(reservation_id))
```

There is no duplicated reservation in our dataset.

```{r}
# Outlier detection
booking_data %>% 
  ggplot(aes(x = nightly_rate_usd)) +
  geom_boxplot()

# Using z-score
booking_data %>% 
  mutate(z_score = (nightly_rate_usd - mean(nightly_rate_usd)) / sd(nightly_rate_usd)) %>% 
  filter(abs(z_score) > 3)
```

There are certainly outliers in our target varaible nightly_rate_usd. We will need to acknowledge this during the modelling phase as some of the methods are sensitive to outliers (e.g., Linear Regression) while others are more robust and less affected (e.g., Random Forest). As such, we will not remove them from the dataset.

## Data Cleaning

```{r}
booking_data <- booking_data %>% 
  # Initial cleaning
  mutate(across(c(added_date, modified_date, created_date, check_in, check_out, cancel_date), as.Date)) %>% 
  mutate(start_bed_type = gsub(",", "", start_bed_type),
         start_cancel_policy = ifelse(start_cancel_policy == "6 Or More Days Before Checkin", "6 or More Days Before Checkin", start_cancel_policy)) 
```

## Feature Engineering

### Feature Creation

```{r}
data <- booking_data %>% 
  mutate(free_wifi = ifelse(grepl("Free Wifi", start_amenities), 1,0),
         free_breakfast = ifelse(grepl("Free Breakfast", start_amenities), 1,0),
         free_parking = ifelse(grepl("Free Breakfast", start_amenities), 1,0),
         concierge = ifelse(grepl("Concierge", start_amenities), 1,0),
         amenities = free_wifi+free_breakfast+free_parking+concierge,
         cancelled = ifelse(!is.na(cancel_date),1,0),
         cancel_after_booking = as.numeric(cancel_date - created_date),
         cancel_before_checkin = as.numeric(check_in - cancel_date),
         leadtime = as.numeric(check_in - created_date),
         checkin_month = month(check_in),
         weekday_booking = mapply(function(x,y) sum(!weekdays(seq(x, y,"days")) %in% c("Saturday", "Sunday")), check_in,check_out),
         weekdend_booking = mapply(function(x,y) sum(weekdays(seq(x, y,"days")) %in% c("Saturday", "Sunday")), check_in,check_out),
         booking_change = ifelse(added_date == modified_date, 0,1),
         ) %>% 
  # Previous cancellation per company (client)
  group_by(company_id) %>% 
  mutate(client_cancellation = sum(cancelled)) %>% 
  ungroup() %>% 
  # Previous cancellation per agency
  group_by(agency_id) %>% 
  mutate(agency_cancellation = sum(cancelled)) %>% 
  ungroup() %>% 
  # Previous cancellation per hotel
  group_by(hotel_brand_name) %>% 
  mutate(hotel_cancellation = sum(cancelled)) %>% 
  ungroup()
```

### Feature Transformation

```{r}

```

### Feature Selection

# Classification

## Interpretation

## Prediction

# Regression

## Interpretation

## Prediction
